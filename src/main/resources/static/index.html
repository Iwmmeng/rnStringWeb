<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>字符串解析</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*" charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- 最新版本的 Bootstrap 核心 CSS 文件 -->
    <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">-->
    <!-- 最新的 Bootstrap 核心 JavaScript 文件 -->
    <!--<script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>-->
    <script src="/js/findByAll8.js"></script>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap-table.js"></script>
    <script src="/js/bootstrap-table-zh-CN.js"></script>
</head>
<body ms-controller="viewmodel">
  <h1></h1>
  <h1></h1>
  <h3>解析文件</h3>
  <div class="input-group mb-3">
      <!--<div class="input-group-prepend">-->
          <!--<span class="input-group-text">请上传文件</span>-->
      <!--</div>-->
      <input type="file" class="form-control" placeholder="请选择文件" multiple="multiple" id="file" onchange="validate()" />
      <div class="input-group-prepend">
          <span class="input-group-text">请输入产品名</span>
      </div>
      <input type="text" class="form-control" placeholder="产品名" id="productName" oninput="validate()" />
      <input type="submit" class="btn btn-info" value="上传" disabled id="upladFile" onclick="upladFile()" />
  </div>

  <h1></h1>
  <h1></h1>
  <h1></h1>
  <h3>按照条件查询</h3>
  <div class="input-group mb-3">
      <div class="input-group-prepend">
          <span class="input-group-text">请输入</span>
      </div>
      <input type="text" class="form-control" placeholder="Key Name" id="keyName">
      <input type="text" class="form-control" placeholder="File Name" id="fileName">
      <!--<input type="text" class="form-control" placeholder="Product Name" id="productName">-->
      <select id="mySelect" onchange="selectChange()"></select>
      <input type="submit" class="btn btn-info" value="搜索" id="btSearch">
  </div>

  <h3>查询结果</h3>
  <!--<p>通过添加 .table-striped 类，来设置条纹表格:</p>-->
  <div class="tableArea ">
      <table class="table table-striped" id="table" data-height="600">
          <!--在此处填充表格数据-->
          <!--<thead id="thead">-->
          <!--</thead>-->
          <tbody id="tbody-result">
          </tbody>
      </table>
  </div>
</body>
<script type="text/javascript">
    // validate
    function validate () {
        var file = $("#file").val()
        var productName = $("#productName").val()

        if (file && productName) {
          // 文件值和产品名非空，上传按钮可点
          $('#upladFile').attr('disabled', false)
        } else {
          // 文件值或产品名空，上传按钮不可点
          $('#upladFile').attr('disabled', true)
        }
    }

    // selectChange
    function selectChange () {
        var value = $("#mySelect").val();
        console.log("value is "+value);

//        alert('选中值为：' + value)
    }

    // 访问后台去数据库查询select的选项
    function getProduct () {
        $.ajax({
            type: "get",
            url: "http://10.38.163.192:9090/info/productlist",
            success: function (productList) {
                var option;
                option = "<option>select productName</option>";

                //循环，i为下标从0开始，n为集合中对应的第i个对象
                $.each(productList, function (i, n) {
                  option += "<option>" + n + "</option>";
                });
                // 将循环拼接的字符串插入第二个下拉列表
                $("#mySelect").html(option);

                // 把第二个下拉列表展示
                // $("#mySelect").show();
            }
        })
    }

    // 获取 productNameList
    getProduct();

    // 上传文件方法
    function upladFile () {
        // XMLHttpRequest 对象
        var xhr = new XMLHttpRequest();
        // FormData 对象
        var formData = new FormData();
        // js 获取文件对象
        var fileObj = document.getElementById("file").files;
        var fileSize = fileObj.length;
        var file;
        for (var i = 0; i < fileSize; i++) {
            file = fileObj[i];
            formData.append("file", file); // 文件对象
        }
        var productName = document.getElementById("productName").value.trim();
        formData.append("product", productName);

        console.log("fileObj is  " + fileObj.size);

        console.log("===upload start===");

        // 接收上传文件的后台地址
        var url = "http://10.38.163.192:9090/upload";
        // 返回值类型为blob
        xhr.responseType = "blob";
        // post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
        xhr.open("post", url, true);
        // 开始上传，发送form数据
        xhr.send(formData);

        xhr.onload = function (oEvent) {
            console.log("===upload complete===");

            // 下载文件
            var content = xhr.response;
            var elink = document.createElement('a');
            elink.download = "resultFile.zip";
            elink.style.display = 'none';
            var blob = new Blob([content]);
            elink.href = URL.createObjectURL(blob);
            document.body.appendChild(elink);
            elink.click();
            document.body.removeChild(elink);

            // 重新获取 productNameList
            getProduct();
        };
    }
</script>
</html>
