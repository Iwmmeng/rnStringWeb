<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <title>字符串解析</title>
    <meta http-equiv="Access-Control-Allow-Origin" content="*" charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/bootstrap-table.min.css">
</head>
<body ms-controller="viewmodel">
  <h1></h1>
  <h1></h1>
  <h3>解析文件</h3>
  <div class="input-group mb-3">
      <!--<div class="input-group-prepend">-->
          <!--<span class="input-group-text">请上传文件</span>-->
      <!--</div>-->
      <input type="file" class="form-control" placeholder="请选择文件" multiple="multiple" id="file" onchange="validate()" />
      <div class="input-group-prepend">
          <span class="input-group-text">请输入产品名</span>
      </div>
      <input type="text" class="form-control" placeholder="产品名" id="productName" oninput="validate()" />
      <input type="submit" class="btn btn-info" value="上传" disabled id="upladFile" onclick="upladFile()" />
  </div>

  <h1></h1>
  <h1></h1>
  <h1></h1>
  <h3>按照条件查询</h3>
  <div class="input-group mb-3">
      <div class="input-group-prepend">
          <span class="input-group-text">请输入</span>
      </div>
      <input type="text" class="form-control" placeholder="Key Name" id="keyName">
      <input type="text" class="form-control" placeholder="File Name" id="fileName">
      <!--<input type="text" class="form-control" placeholder="Product Name" id="productName">-->
      <select id="mySelect" onchange="selectChange()"></select>
      <input type="submit" class="btn btn-info" value="搜索" id="btSearch">
  </div>

  <h3>查询结果</h3>
  <!--<p>通过添加 .table-striped 类，来设置条纹表格:</p>-->
  <div class="tableArea">
      <table class="table table-striped" id="table">

      </table>
  </div>
</body>

<!-- jquery -->
<script src="/js/jquery-3.4.1.min.js"></script>
<!-- popper -->
<script src="/js/popper.min.js"></script>
<!-- bootstrap -->
<script src="/js/bootstrap.min.js"></script>
<!-- bootstrap-table -->
<script src="/js/bootstrap-table.js"></script>
<script src="/js/bootstrap-table-zh-CN.js"></script>
<script src="/js/findByAll8.js"></script>





<script type="text/javascript">
    // validate
    function validate () {
        var file = $("#file").val()
        var productName = $("#productName").val()

        if (file && productName) {
          // 文件值和产品名非空，上传按钮可点
          $('#upladFile').attr('disabled', false)
        } else {
          // 文件值或产品名空，上传按钮不可点
          $('#upladFile').attr('disabled', true)
        }
    }

    // selectChange
    function selectChange () {
        var value = $("#mySelect").val();

        console.log("value is "+value);

        // alert('选中值为：' + value)
    }

    // 访问后台去数据库查询select的选项
    function getProduct () {
        $.ajax({
            type: "get",
            url: "http://10.234.22.121:9090/info/productlist",
            success: function (productList) {
                var option;
                option = "<option>select productName</option>";

                //循环，i为下标从0开始，n为集合中对应的第i个对象
                $.each(productList, function (i, n) {
                  option += "<option>" + n + "</option>";
                });
                // 将循环拼接的字符串插入第二个下拉列表
                $("#mySelect").html(option);

                // 把第二个下拉列表展示
                // $("#mySelect").show();
            }
        })
    }

    // 获取 productNameList
    getProduct();

    // 上传文件方法
    function upladFile () {
        // XMLHttpRequest 对象
        var xhr = new XMLHttpRequest();
        // FormData 对象
        var formData = new FormData();
        // js 获取文件对象
        var fileObj = document.getElementById("file").files;
        var fileSize = fileObj.length;
        var file;
        for (var i = 0; i < fileSize; i++) {
            file = fileObj[i];
            formData.append("file", file); // 文件对象
        }
        var productName = document.getElementById("productName").value.trim();
        formData.append("product", productName);

        console.log("fileObj is  " + fileObj.size);

        console.log("===upload start===");

        // 接收上传文件的后台地址
        var url = "http://10.234.22.121:9090/upload";
        // 返回值类型为blob
        xhr.responseType = "blob";
        // post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
        xhr.open("post", url, true);
        // 开始上传，发送form数据
        xhr.send(formData);

        xhr.onload = function (oEvent) {
            console.log("===upload complete===");

            // 下载文件
            var content = xhr.response;
            var elink = document.createElement('a');
            elink.download = "resultFile.zip";
            elink.style.display = 'none';
            var blob = new Blob([content]);
            elink.href = URL.createObjectURL(blob);
            document.body.appendChild(elink);
            elink.click();
            document.body.removeChild(elink);

            // 重新获取 productNameList
            getProduct();
        };
    }
</script>
</html>
